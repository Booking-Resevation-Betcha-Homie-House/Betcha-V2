<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NextBtn1 Integration Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-2xl mx-auto bg-white p-6 rounded-lg shadow-lg">
        <h1 class="text-2xl font-bold mb-6 text-center">NextBtn1 Integration Test</h1>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Test Controls -->
            <div class="space-y-4">
                <h2 class="text-lg font-semibold">Test Controls</h2>
                
                <!-- ID Dropdown -->
                <div>
                    <label class="block text-sm font-medium mb-2">Valid ID</label>
                    <div class="relative">
                        <button type="button" id="IDDropdownBtn" class="w-full p-3 border border-gray-300 rounded-lg flex justify-between items-center">
                            <span id="selectedID" class="text-gray-500">Select valid ID</span>
                            <svg id="IDDropdownIcon" class="w-4 h-4" viewBox="0 0 16 10">
                                <path d="M1 1.5L8 8.5L15 1.5" stroke="#666666" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                        </button>
                        <ul id="IDDropdownList" class="absolute z-10 mt-1 bg-white w-full border border-gray-300 rounded-lg shadow hidden">
                            <li class="px-4 py-2 hover:bg-gray-100 cursor-pointer" onclick="selectID('Driver\'s License')">Driver's License</li>
                        </ul>
                    </div>
                </div>
                
                <!-- File Upload -->
                <div>
                    <label class="block text-sm font-medium mb-2">Upload Driver's License</label>
                    <input type="file" id="IDfileInput" accept=".jpg,.jpeg,.png,.webp" class="w-full p-3 border border-gray-300 rounded-lg">
                    <div id="IDpreviewContainer" class="mt-2"></div>
                </div>
                
                <!-- Test Buttons -->
                <div class="space-y-2">
                    <button id="nextBtn1" type="button" class="w-full bg-blue-500 text-white p-3 rounded-lg hover:bg-blue-600 transition-colors">
                        Next - Start OCR Scan
                    </button>
                    
                    <button id="testError" type="button" class="w-full bg-red-500 text-white p-3 rounded-lg hover:bg-red-600 transition-colors">
                        Test Error Modal
                    </button>
                    
                    <button id="testLoading" type="button" class="w-full bg-purple-500 text-white p-3 rounded-lg hover:bg-purple-600 transition-colors">
                        Test Loading Overlay
                    </button>
                </div>
            </div>
            
            <!-- Test Results -->
            <div>
                <h2 class="text-lg font-semibold mb-4">Test Results</h2>
                
                <!-- Expected Behavior Checklist -->
                <div class="bg-gray-50 p-4 rounded-lg mb-4">
                    <h3 class="font-bold mb-2">Expected Behavior Checklist:</h3>
                    <div class="space-y-1 text-sm">
                        <div id="check-validation" class="flex items-center">
                            <span class="w-4 h-4 mr-2">‚è≥</span>
                            <span>Validates ID selection and file upload</span>
                        </div>
                        <div id="check-loading" class="flex items-center">
                            <span class="w-4 h-4 mr-2">‚è≥</span>
                            <span>Shows fullscreen loading overlay</span>
                        </div>
                        <div id="check-api" class="flex items-center">
                            <span class="w-4 h-4 mr-2">‚è≥</span>
                            <span>Calls OCR API with image file</span>
                        </div>
                        <div id="check-modal" class="flex items-center">
                            <span class="w-4 h-4 mr-2">‚è≥</span>
                            <span>Shows modal error on failure</span>
                        </div>
                        <div id="check-navigation" class="flex items-center">
                            <span class="w-4 h-4 mr-2">‚è≥</span>
                            <span>Prevents step 2 navigation on error</span>
                        </div>
                    </div>
                </div>
                
                <!-- Console Log -->
                <div>
                    <h3 class="font-bold mb-2">Console Output:</h3>
                    <div id="console-logs" class="bg-gray-100 p-3 rounded text-xs max-h-40 overflow-y-auto font-mono"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for error display -->
    <div id="confirmModal" class="fixed inset-0 bg-black/50 items-center justify-center hidden z-50" style="display: none;">
        <div class="bg-white w-96 rounded-lg shadow-xl">
            <div class="p-6" id="registeredModal">
                <!-- Error content will be injected here -->
            </div>
        </div>
    </div>

    <script>
        // Console logging to UI
        const originalLog = console.log;
        const originalError = console.error;
        const logsDiv = document.getElementById('console-logs');
        
        function addLog(message, type = 'log') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = type === 'error' ? 'text-red-600' : type === 'success' ? 'text-green-600' : 'text-gray-700';
            logEntry.textContent = `[${timestamp}] ${message}`;
            logsDiv.appendChild(logEntry);
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            addLog(args.join(' '), 'log');
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            addLog(args.join(' '), 'error');
        };

        // Helper functions
        function updateCheck(id, status) {
            const element = document.getElementById(id);
            const icon = element.querySelector('span:first-child');
            if (status === 'pass') {
                icon.textContent = '‚úÖ';
                icon.className = 'w-4 h-4 mr-2 text-green-600';
            } else if (status === 'fail') {
                icon.textContent = '‚ùå';
                icon.className = 'w-4 h-4 mr-2 text-red-600';
            } else {
                icon.textContent = '‚è≥';
                icon.className = 'w-4 h-4 mr-2 text-yellow-600';
            }
        }

        // ID selection
        function selectID(id) {
            document.getElementById('selectedID').textContent = id;
            document.getElementById('IDDropdownList').classList.add('hidden');
            console.log('ID selected:', id);
            updateCheck('check-validation', 'pass');
        }
        
        // Toggle dropdown
        document.getElementById('IDDropdownBtn').addEventListener('click', () => {
            document.getElementById('IDDropdownList').classList.toggle('hidden');
        });
        
        // File upload
        document.getElementById('IDfileInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            const container = document.getElementById('IDpreviewContainer');
            if (file) {
                container.innerHTML = `<div class="text-sm text-gray-600 p-2 bg-gray-50 rounded">üìÅ ${file.name} (${Math.round(file.size/1024)}KB)</div>`;
                console.log('File selected:', file.name, 'Size:', file.size);
            } else {
                container.innerHTML = '';
            }
        });

        // Mock functions (will be replaced by actual ones)
        function showFullscreenLoading(message = 'Loading') {
            console.log('üîÑ Showing fullscreen loading:', message);
            updateCheck('check-loading', 'pass');
            
            const loadingOverlay = document.createElement('div');
            loadingOverlay.id = 'fullscreen-loading-overlay';
            loadingOverlay.className = 'fixed inset-0 z-[999] flex items-center justify-center bg-black/50 backdrop-blur-sm';
            
            const content = `
                <div class="text-center">
                    <div class="animate-spin rounded-full h-24 w-24 border-b-4 border-white mx-auto mb-6"></div>
                    <p class="text-white text-lg">${message}</p>
                </div>
            `;
            
            loadingOverlay.innerHTML = content;
            document.body.appendChild(loadingOverlay);
        }

        function hideFullscreenLoading() {
            console.log('‚úÖ Hiding fullscreen loading');
            const existingOverlays = document.querySelectorAll('[id^="fullscreen-loading"]');
            existingOverlays.forEach(overlay => overlay.remove());
        }

        function showOCRError(errorMessage) {
            console.log('‚ùå Showing OCR error:', errorMessage);
            updateCheck('check-modal', 'pass');
            updateCheck('check-navigation', 'pass');
            
            const confirmModal = document.getElementById('confirmModal');
            const modalContent = document.getElementById('registeredModal');
            
            modalContent.innerHTML = `
                <div class="text-center">
                    <svg class="w-16 h-16 text-red-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">ID Scan Failed</h3>
                    <p class="text-gray-600 mb-6">${errorMessage}</p>
                    <button onclick="closeOCRErrorModal()" class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition-colors">
                        Try Again
                    </button>
                </div>
            `;

            confirmModal.style.display = 'flex';
            confirmModal.classList.remove('hidden');
        }

        function closeOCRErrorModal() {
            const confirmModal = document.getElementById('confirmModal');
            confirmModal.style.display = 'none';
            confirmModal.classList.add('hidden');
        }

        // Make functions globally available
        window.closeOCRErrorModal = closeOCRErrorModal;

        async function scanDriversLicense(imageFile) {
            try {
                console.log('üîç Starting OCR scan for driver\'s license...');
                updateCheck('check-api', 'pass');
                
                const formData = new FormData();
                formData.append('image', imageFile);
                
                console.log('üì° Calling API: https://betcha-api.onrender.com/ocr/scan/drivers-license');
                const response = await fetch('https://betcha-api.onrender.com/ocr/scan/drivers-license', {
                    method: 'POST',
                    body: formData
                });
                
                console.log('üì• Response status:', response.status);
                const data = await response.json();
                console.log('üìÑ OCR Response:', data);
                
                if (!response.ok) {
                    throw new Error(data.message || 'OCR scanning failed');
                }
                
                const requiredFields = ['birthday', 'firstName', 'lastName'];
                const missingFields = requiredFields.filter(field => !data[field] || data[field] === null);
                
                if (missingFields.length > 0) {
                    throw new Error('Incomplete data extracted from ID. Missing: ' + missingFields.join(', '));
                }
                
                return data;
            } catch (error) {
                console.error('OCR Error:', error);
                throw error;
            }
        }

        // Test button event handlers
        document.getElementById('nextBtn1').addEventListener('click', async (e) => {
            e.preventDefault();
            console.log('üöÄ NextBtn1 clicked - starting test...');
            
            try {
                // Reset all checks
                ['check-validation', 'check-loading', 'check-api', 'check-modal', 'check-navigation'].forEach(id => {
                    updateCheck(id, 'pending');
                });
                
                // Validate step 1
                const selectedID = document.getElementById('selectedID').textContent.trim();
                const fileInput = document.getElementById('IDfileInput');
                const hasUploadedFiles = fileInput.files.length > 0;

                console.log('üîç Validation check:');
                console.log('- Selected ID:', selectedID);
                console.log('- Has files:', hasUploadedFiles);

                if (!selectedID || selectedID === 'Select valid ID') {
                    console.error('‚ùå Validation failed: No ID type selected');
                    updateCheck('check-validation', 'fail');
                    showOCRError('Please select a valid ID type first.');
                    return;
                }

                if (!hasUploadedFiles) {
                    console.error('‚ùå Validation failed: No file uploaded');
                    updateCheck('check-validation', 'fail');
                    showOCRError('Please upload your driver\'s license image first.');
                    return;
                }

                updateCheck('check-validation', 'pass');
                console.log('‚úÖ Validation passed, starting OCR scan...');
                
                // Show fullscreen loading
                showFullscreenLoading('Scanning driver\'s license');
                
                const imageFile = fileInput.files[0];
                console.log('üìÅ Found image file:', imageFile.name, 'Size:', imageFile.size);
                
                // Perform OCR scan
                const ocrData = await scanDriversLicense(imageFile);
                console.log('‚úÖ OCR scan successful:', ocrData);
                
                // Hide loading and show success message briefly
                hideFullscreenLoading();
                showFullscreenLoading('Processing data');
                
                // Brief delay to show processing
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Hide loading
                hideFullscreenLoading();
                
                console.log('üéâ Process completed successfully!');
                addLog('SUCCESS: All checks passed!', 'success');
                
            } catch (error) {
                console.error('‚ùå Error during OCR scan:', error);
                hideFullscreenLoading();
                showOCRError(`Failed to scan driver's license: ${error.message}`);
            }
        });

        // Test error modal button
        document.getElementById('testError').addEventListener('click', () => {
            console.log('üß™ Testing error modal...');
            showOCRError('This is a test error message to verify the modal functionality.');
        });

        // Test loading overlay button
        document.getElementById('testLoading').addEventListener('click', async () => {
            console.log('üß™ Testing loading overlay...');
            showFullscreenLoading('Testing loading overlay');
            await new Promise(resolve => setTimeout(resolve, 2000));
            hideFullscreenLoading();
            console.log('‚úÖ Loading test completed');
        });

        console.log('üöÄ NextBtn1 integration test initialized');
        addLog('Integration test ready. Upload an image and click "Next" to test.', 'success');
    </script>
</body>
</html>
