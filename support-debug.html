<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Support Tickets Debug</title>
    <link rel="stylesheet" href="/src/index.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .debug-container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button {
            margin: 10px 5px;
            padding: 8px 15px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        .info {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #007bff;
            margin: 10px 0;
        }
        .api-preview {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="debug-container">
        <h1>Support Tickets Debug</h1>
        <p>This page helps test the ticket list functionality on the support page.</p>

        <div class="info">
            <h4>üéØ What this tests:</h4>
            <ul>
                <li>Setting user ID in localStorage</li>
                <li>Fetching tickets from API</li>
                <li>Displaying ticket cards with proper formatting</li>
                <li>Status badges and time formatting</li>
            </ul>
        </div>

        <div>
            <h3>User Setup</h3>
            <button onclick="setTestUser()">Set Test User (685009ff53a090e126b9e2b4)</button>
            <button onclick="clearUser()">Clear User</button>
            <button onclick="checkUser()">Check Current User</button>
            
            <div id="userStatus" class="info">
                Click "Check Current User" to see current state
            </div>
        </div>

        <div>
            <h3>API Test</h3>
            <button onclick="testAPI()">Test Tickets API</button>
            <button onclick="testAgentAPI()">Test Agent Name API</button>
            <button onclick="openSupportPage()">Open Support Page</button>
            
            <div id="apiResults" class="api-preview">
                Click "Test Tickets API" to see API response
            </div>
        </div>

        <div>
            <h3>Expected Ticket Data</h3>
            <div class="api-preview">
                Based on the API response, you should see tickets with <strong>real agent names</strong>:
                <ul>
                    <li><strong>Ticket #00000005</strong> - Date Issue (In Queue) - CSR: [Real Agent Name]</li>
                    <li><strong>Ticket #00000004</strong> - Date Issue (Resolved) - CSR: [Real Agent Name]</li>
                    <li><strong>Ticket #00000003</strong> - Booking Issue (Resolved) - CSR: [Real Agent Name]</li>
                    <li><strong>Ticket #00000002</strong> - Booking Issue (Resolved) - CSR: [Real Agent Name]</li>
                    <li><strong>Ticket #00000001</strong> - Booking Issue (No status) - CSR: No Agent Assigned</li>
                </ul>
                <br>
                <strong>New Feature:</strong> Agent names are now fetched from the employee API using customerServiceAgentId!
            </div>
        </div>
    </div>

    <script>
        function setTestUser() {
            localStorage.setItem('userId', '685009ff53a090e126b9e2b4');
            updateUserStatus('‚úÖ Test user set: 685009ff53a090e126b9e2b4');
        }

        function clearUser() {
            localStorage.removeItem('userId');
            localStorage.removeItem('userID');
            localStorage.removeItem('currentUser');
            updateUserStatus('‚ùå User cleared from localStorage');
        }

        function checkUser() {
            const userId = localStorage.getItem('userId') || 
                          localStorage.getItem('userID') || 
                          localStorage.getItem('currentUser');
            
            if (userId) {
                updateUserStatus(`‚úÖ Current user: ${userId}`);
            } else {
                updateUserStatus('‚ùå No user found in localStorage');
            }
        }

        function updateUserStatus(message) {
            document.getElementById('userStatus').innerHTML = message;
        }

        async function testAPI() {
            const userId = localStorage.getItem('userId') || 
                          localStorage.getItem('userID') || 
                          localStorage.getItem('currentUser');
            
            if (!userId) {
                document.getElementById('apiResults').innerHTML = '‚ùå No user ID found. Set a test user first.';
                return;
            }

            try {
                document.getElementById('apiResults').innerHTML = 'üîÑ Fetching tickets...';
                
                const response = await fetch(`https://betcha-api.onrender.com/tk/sender/${userId}`);
                const data = await response.json();
                
                if (response.ok) {
                    document.getElementById('apiResults').innerHTML = `
                        ‚úÖ API Success - Found ${data.tickets.length} tickets<br><br>
                        <strong>Tickets:</strong><br>
                        ${data.tickets.map(ticket => 
                            `#${ticket.ticketNumber} - ${ticket.category} (${ticket.status || 'No status'})`
                        ).join('<br>')}
                        <br><br>
                        <details>
                            <summary>Full API Response</summary>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </details>
                    `;
                } else {
                    document.getElementById('apiResults').innerHTML = `‚ùå API Error: ${data.message || 'Unknown error'}`;
                }
            } catch (error) {
                document.getElementById('apiResults').innerHTML = `‚ùå Network Error: ${error.message}`;
            }
        }

        async function testAgentAPI() {
            try {
                document.getElementById('apiResults').innerHTML = 'üîÑ Testing agent API...';
                
                // Test with a sample agent ID from the error logs
                const testAgentId = '68a85740a3af5eecc10e7cae'; // Sample ID from error
                const response = await fetch(`https://betcha-api.onrender.com/employee/display/customerServiceId`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        customerServiceId: testAgentId
                    })
                });
                const data = await response.json();
                
                if (response.ok) {
                    document.getElementById('apiResults').innerHTML = `
                        ‚úÖ Agent API Success<br><br>
                        <strong>Agent Info:</strong><br>
                        Name: ${data.employee.firstName} ${data.employee.lastName}<br>
                        Employee ID: ${data.employee.employeeId}<br>
                        Role: ${data.employee.role}<br>
                        <br>
                        <details>
                            <summary>Full Agent Response</summary>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </details>
                    `;
                } else {
                    document.getElementById('apiResults').innerHTML = `‚ùå Agent API Error: ${data.message || 'Unknown error'}`;
                }
            } catch (error) {
                document.getElementById('apiResults').innerHTML = `‚ùå Network Error: ${error.message}`;
            }
        }

        function openSupportPage() {
            window.open('/pages/auth/support.html', '_blank');
        }

        // Auto-check user on page load
        document.addEventListener('DOMContentLoaded', () => {
            checkUser();
        });
    </script>
</body>
</html>
