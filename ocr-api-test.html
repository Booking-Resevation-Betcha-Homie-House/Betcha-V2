<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OCR API Test - Registration</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-md mx-auto bg-white p-6 rounded-lg">
        <h1 class="text-xl font-bold mb-4">OCR API Test - Registration Step 1</h1>
        
        <!-- ID Type Selection -->
        <div class="mb-4">
            <label class="block text-sm font-medium mb-2">ID Type:</label>
            <div class="relative">
                <button id="IDDropdownBtn" class="w-full p-3 border rounded-lg text-left bg-white flex items-center justify-between">
                    <span id="selectedID">Driver's License</span>
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </button>
            </div>
        </div>
        
        <!-- File Upload -->
        <div class="mb-6">
            <label class="block text-sm font-medium mb-2">Upload Driver's License:</label>
            <input type="file" id="IDfileInput" accept="image/*" class="w-full p-3 border rounded-lg">
            <div id="IDpreviewContainer" class="mt-2"></div>
        </div>
        
        <!-- Next Button (Exact copy from register.html) -->
        <div class="mt-10">
            <button id="nextBtn1" type="button" class="group relative w-full bg-blue-600 text-white px-6 py-3 rounded-full flex items-center justify-center overflow-hidden
            hover:cursor-pointer active:scale-95
            transition-all duration-500 ease-in-out"
            data-step="1">
                <span class="text-white text-base group-hover:-translate-x-1
                transition-transform duration-500 ease-in-out 
                md:text-lg">Next</span>
                <span
                    class="overflow-hidden max-w-[30px] lg:max-w-0 lg:group-hover:max-w-[30px] transition-all duration-500 ease-in-out">
                    <svg class="w-5 h-5 ml-2 fill-white" viewBox="0 0 24 25"
                        xmlns="http://www.w3.org/2000/svg">
                        <path
                            d="M14.707 6.13598L20.364 11.793C20.5515 11.9805 20.6568 12.2348 20.6568 12.5C20.6568 12.7651 20.5515 13.0194 20.364 13.207L14.707 18.864C14.5184 19.0461 14.2658 19.1469 14.0036 19.1447C13.7414 19.1424 13.4906 19.0372 13.3052 18.8518C13.1198 18.6664 13.0146 18.4156 13.0123 18.1534C13.01 17.8912 13.1108 17.6386 13.293 17.45L17.243 13.5H4C3.73478 13.5 3.48043 13.3946 3.29289 13.2071C3.10536 13.0195 3 12.7652 3 12.5C3 12.2348 3.10536 11.9804 3.29289 11.7929C3.48043 11.6053 3.73478 11.5 4 11.5H17.243L13.293 7.54998C13.1975 7.45773 13.1213 7.34739 13.0689 7.22538C13.0165 7.10338 12.9889 6.97216 12.9877 6.83938C12.9866 6.7066 13.0119 6.57492 13.0622 6.45202C13.1125 6.32913 13.1867 6.21747 13.2806 6.12358C13.3745 6.02969 13.4861 5.95544 13.609 5.90516C13.7319 5.85487 13.8636 5.82957 13.9964 5.83073C14.1292 5.83188 14.2604 5.85947 14.3824 5.91188C14.5044 5.96428 14.6148 6.04047 14.707 6.13598Z" />
                    </svg>
                </span>
            </button>
        </div>
        
        <!-- Test Buttons -->
        <div class="mt-6 space-y-2">
            <button id="testLoadingBtn" class="w-full px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
                Test Fullscreen Loading
            </button>
            <button id="testApiBtn" class="w-full px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700">
                Test OCR API Call
            </button>
        </div>
        
        <!-- Status Log -->
        <div id="statusLog" class="mt-6 p-4 bg-gray-50 rounded-lg">
            <h3 class="font-semibold mb-2">Status Log:</h3>
            <div id="logMessages" class="text-sm space-y-1 max-h-60 overflow-y-auto"></div>
        </div>

        <!-- Step 2 Hidden (for navigation test) -->
        <div id="step2" class="hidden mt-6 p-4 bg-green-50 rounded-lg">
            <h2 class="text-lg font-bold text-green-800">Step 2 - Personal Information</h2>
            <p class="text-green-600">Successfully moved to Step 2! OCR data should be auto-filled here.</p>
            
            <div class="grid grid-cols-2 gap-4 mt-4">
                <input type="text" placeholder="First name" class="p-2 border rounded">
                <input type="text" placeholder="Last name" class="p-2 border rounded">
            </div>
            <input type="text" placeholder="Middle name" class="p-2 border rounded w-full mt-2">
            
            <!-- Birthday dropdowns -->
            <div class="grid grid-cols-3 gap-2 mt-4">
                <div class="text-center">
                    <span id="selectedMonth" class="text-gray-400">Month</span>
                </div>
                <div class="text-center">
                    <span id="selectedDay" class="text-gray-400">Day</span>
                </div>
                <div class="text-center">
                    <span id="selectedYear" class="text-gray-400">Year</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden elements for progress -->
    <div class="hidden">
        <div id="step1">Step 1 content</div>
        <div id="step-label">Step 1 of 3</div>
        <div id="progress-bar" style="width: 33.33%"></div>
    </div>

    <script>
        // Logging function
        function log(message, type = 'info') {
            const logDiv = document.getElementById('logMessages');
            const logItem = document.createElement('div');
            logItem.className = `p-2 rounded ${
                type === 'success' ? 'bg-green-100 text-green-800' : 
                type === 'error' ? 'bg-red-100 text-red-800' : 
                type === 'warning' ? 'bg-yellow-100 text-yellow-800' :
                'bg-blue-100 text-blue-800'
            }`;
            logItem.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(logItem);
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        // Fullscreen loading functions
        function showFullscreenLoading(message = 'Loading') {
            const existingOverlays = document.querySelectorAll('[id^="fullscreen-loading"]');
            existingOverlays.forEach(overlay => overlay.remove());
            
            const loadingOverlay = document.createElement('div');
            loadingOverlay.id = 'fullscreen-loading-overlay';
            loadingOverlay.className = 'fixed inset-0 z-[999] flex items-center justify-center bg-black/50 backdrop-blur-sm';
            
            const style = document.createElement('style');
            style.textContent = `
                @keyframes loadingDots {
                    0% { content: ''; }
                    25% { content: '.'; }
                    50% { content: '..'; }
                    75% { content: '...'; }
                    100% { content: ''; }
                }
                .loading-dots::after {
                    content: '';
                    animation: loadingDots 1.5s infinite;
                    display: inline-block;
                    width: 24px;
                    text-align: left;
                }
            `;
            document.head.appendChild(style);
            
            const content = `
                <div class="text-center">
                    <div class="animate-spin rounded-full h-24 w-24 border-b-4 border-white mx-auto mb-6"></div>
                    <p class="text-white text-lg flex items-center justify-center" id="loading-message">
                        <span>${message}</span>
                        <span class="loading-dots"></span>
                    </p>
                </div>
            `;
            
            loadingOverlay.innerHTML = content;
            document.body.appendChild(loadingOverlay);
            log(`Fullscreen loading shown: ${message}`, 'info');
        }

        function hideFullscreenLoading() {
            const existingOverlays = document.querySelectorAll('[id^="fullscreen-loading"]');
            existingOverlays.forEach(overlay => overlay.remove());
            log('Fullscreen loading hidden', 'info');
        }
        
        // Mock functions for testing
        function validateStep1() {
            const fileInput = document.getElementById('IDfileInput');
            const selectedID = document.getElementById('selectedID').textContent;
            
            if (selectedID !== "Driver's License") {
                log('Validation failed: Wrong ID type selected', 'error');
                showError('Please select Driver\'s License as ID type');
                return false;
            }
            
            if (!fileInput.files || fileInput.files.length === 0) {
                log('Validation failed: No file uploaded', 'error');
                showError('Please upload a driver\'s license image');
                return false;
            }
            
            log('Step 1 validation passed', 'success');
            return true;
        }
        
        function showError(message) {
            log(`Error shown: ${message}`, 'error');
            alert(message);
        }
        
        function updateNextButtonState() {
            log('updateNextButtonState called', 'info');
        }
        
        // Real OCR API call
        async function scanDriversLicense(imageFile) {
            log(`Starting OCR scan for: ${imageFile.name} (${imageFile.size} bytes)`, 'info');
            
            try {
                const formData = new FormData();
                formData.append('image', imageFile);
                
                log('Sending request to OCR API...', 'info');
                const response = await fetch('https://betcha-api.onrender.com/ocr/scan/drivers-license', {
                    method: 'POST',
                    body: formData
                });
                
                log(`API Response status: ${response.status}`, response.ok ? 'success' : 'error');
                
                const data = await response.json();
                log(`API Response data: ${JSON.stringify(data)}`, 'info');
                
                if (!response.ok) {
                    throw new Error(data.message || 'OCR scanning failed');
                }
                
                // Validate required fields
                const requiredFields = ['birthday', 'firstName', 'lastName'];
                const missingFields = requiredFields.filter(field => !data[field] || data[field] === null);
                
                if (missingFields.length > 0) {
                    throw new Error(`Missing fields: ${missingFields.join(', ')}`);
                }
                
                log('OCR scan completed successfully', 'success');
                return data;
            } catch (error) {
                log(`OCR Error: ${error.message}`, 'error');
                throw error;
            }
        }
        
        function autoFillFromOCR(ocrData) {
            log(`Auto-filling with: ${JSON.stringify(ocrData)}`, 'success');
            
            // Fill first name
            if (ocrData.firstName) {
                const input = document.querySelector('input[placeholder="First name"]');
                if (input) {
                    input.value = ocrData.firstName;
                    log(`First name filled: ${ocrData.firstName}`, 'success');
                }
            }
            
            // Fill last name
            if (ocrData.lastName) {
                const input = document.querySelector('input[placeholder="Last name"]');
                if (input) {
                    input.value = ocrData.lastName;
                    log(`Last name filled: ${ocrData.lastName}`, 'success');
                }
            }
            
            // Fill middle name
            if (ocrData.middleName) {
                const input = document.querySelector('input[placeholder="Middle name"]');
                if (input) {
                    input.value = ocrData.middleName;
                    log(`Middle name filled: ${ocrData.middleName}`, 'success');
                }
            }
            
            // Fill birthday
            if (ocrData.birthday) {
                const [year, month, day] = ocrData.birthday.split('/');
                
                const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
                const monthElement = document.querySelector('#selectedMonth');
                const dayElement = document.querySelector('#selectedDay');
                const yearElement = document.querySelector('#selectedYear');
                
                if (monthElement && dayElement && yearElement) {
                    const monthIndex = parseInt(month) - 1;
                    monthElement.textContent = monthNames[monthIndex] || month;
                    dayElement.textContent = parseInt(day).toString();
                    yearElement.textContent = year;
                    
                    monthElement.classList.remove('text-gray-400');
                    dayElement.classList.remove('text-gray-400');
                    yearElement.classList.remove('text-gray-400');
                    
                    log(`Birthday filled: ${ocrData.birthday}`, 'success');
                }
            }
        }
        
        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            log('Page loaded, setting up event listeners', 'info');
            
            // File upload handler
            document.getElementById('IDfileInput').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    log(`File selected: ${file.name} (${file.size} bytes)`, 'success');
                    
                    // Show preview
                    const container = document.getElementById('IDpreviewContainer');
                    container.innerHTML = `
                        <div class="text-sm text-green-600 p-2 bg-green-50 rounded">
                            ✓ File ready: ${file.name}
                        </div>
                    `;
                }
            });
            
            // Test loading button
            document.getElementById('testLoadingBtn').addEventListener('click', () => {
                log('Testing fullscreen loading...', 'info');
                showFullscreenLoading('Testing loading screen');
                setTimeout(() => {
                    hideFullscreenLoading();
                }, 3000);
            });
            
            // Test API button
            document.getElementById('testApiBtn').addEventListener('click', async () => {
                const fileInput = document.getElementById('IDfileInput');
                if (!fileInput.files || fileInput.files.length === 0) {
                    log('No file selected for API test', 'error');
                    alert('Please upload a file first');
                    return;
                }
                
                try {
                    showFullscreenLoading('Testing OCR API');
                    const result = await scanDriversLicense(fileInput.files[0]);
                    hideFullscreenLoading();
                    autoFillFromOCR(result);
                } catch (error) {
                    hideFullscreenLoading();
                    log(`API test failed: ${error.message}`, 'error');
                }
            });
            
            // Main Next button
            const nextBtn1 = document.getElementById('nextBtn1');
            if (nextBtn1) {
                nextBtn1.addEventListener('click', async (e) => {
                    e.preventDefault();
                    log('Next button clicked!', 'info');
                    
                    try {
                        if (!validateStep1()) {
                            return;
                        }
                        
                        showFullscreenLoading('Scanning driver\'s license');
                        
                        const fileInput = document.getElementById('IDfileInput');
                        const imageFile = fileInput.files[0];
                        
                        const ocrData = await scanDriversLicense(imageFile);
                        
                        hideFullscreenLoading();
                        showFullscreenLoading('Processing data');
                        
                        autoFillFromOCR(ocrData);
                        
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        hideFullscreenLoading();
                        
                        // Show step 2
                        document.getElementById('step2').classList.remove('hidden');
                        log('Successfully moved to Step 2!', 'success');
                        
                    } catch (error) {
                        hideFullscreenLoading();
                        log(`OCR process failed: ${error.message}`, 'error');
                        showError(`Failed to scan driver's license: ${error.message}`);
                    }
                });
                
                log('Event listener attached to nextBtn1', 'success');
            } else {
                log('nextBtn1 button not found!', 'error');
            }
        });
    </script>
</body>
</html>
