<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TK API Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .ticket-item {
            padding: 15px;
            border: 1px solid #eee;
            margin: 10px 0;
            border-radius: 5px;
            cursor: pointer;
        }
        .ticket-item:hover {
            background-color: #f5f5f5;
        }
        .ticket-active {
            background-color: #e3f2fd;
            border-color: #2196f3;
        }
        .tab-btn {
            padding: 10px 20px;
            margin: 5px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            border-radius: 5px;
        }
        .tab-btn.active {
            background: #2196f3;
            color: white;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .message-bubble {
            padding: 10px;
            margin: 10px 0;
            border-radius: 10px;
            max-width: 70%;
        }
        .message-guest .message-bubble {
            background: #e3f2fd;
            margin-right: auto;
        }
        .message-csr .message-bubble {
            background: #f3e5f5;
            margin-left: auto;
        }
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        .status-pending {
            background: #fff3e0;
            color: #f57c00;
        }
        .status-resolved {
            background: #e8f5e8;
            color: #388e3c;
        }
    </style>
</head>
<body>
    <h1>TK API Test - Customer Service Tickets</h1>
    
    <div class="test-section">
        <h2>API Status</h2>
        <div id="apiStatus">Checking API connection...</div>
        <button onclick="testAPI()">Test API Connection</button>
    </div>

    <div class="test-section">
        <h2>Local Storage Check</h2>
        <div id="localStorageStatus">Checking localStorage...</div>
        <button onclick="checkLocalStorage()">Check localStorage</button>
    </div>

    <div class="test-section">
        <h2>Ticket List</h2>
        <div class="tab-buttons">
            <button class="tab-btn active" onclick="setActiveTab(0)">Pending</button>
            <button class="tab-btn" onclick="setActiveTab(1)">Completed</button>
        </div>
        
        <div class="tab-content active" id="pending-tab">
            <div id="pending-tickets">Loading pending tickets...</div>
        </div>
        
        <div class="tab-content" id="completed-tab">
            <div id="completed-tickets">Loading completed tickets...</div>
        </div>
    </div>

    <div class="test-section">
        <h2>Selected Ticket Details</h2>
        <div id="ticket-details">No ticket selected</div>
    </div>

    <script>
        // API Base URL
        const API_BASE_URL = 'https://betcha-api.onrender.com';

        // Test API connection
        async function testAPI() {
            const statusDiv = document.getElementById('apiStatus');
            statusDiv.textContent = 'Testing API connection...';
            
            try {
                const response = await fetch(`${API_BASE_URL}/tk/customer-service/test`);
                if (response.ok) {
                    statusDiv.textContent = '✅ API is accessible';
                } else {
                    statusDiv.textContent = `⚠️ API responded with status: ${response.status}`;
                }
            } catch (error) {
                statusDiv.textContent = `❌ API connection failed: ${error.message}`;
            }
        }

        // Check localStorage
        function checkLocalStorage() {
            const statusDiv = document.getElementById('localStorageStatus');
            const userID = localStorage.getItem('userId');
            const roleID = localStorage.getItem('roleID');
            
            // Get all localStorage keys
            const allKeys = Object.keys(localStorage);
            const allKeysText = allKeys.length > 0 ? allKeys.join(', ') : 'No keys found';
            
            if (userID && roleID) {
                statusDiv.innerHTML = `
                    ✅ localStorage found:<br>
                    userId: ${userID}<br>
                    roleID: ${roleID}<br>
                    <br>All available keys: ${allKeysText}
                `;
            } else {
                statusDiv.innerHTML = `
                    ❌ localStorage missing:<br>
                    userId: ${userID || 'NOT FOUND'}<br>
                    roleID: ${roleID || 'NOT FOUND'}<br>
                    <br>All available keys: ${allKeysText}
                `;
            }
        }

        // Set active tab
        function setActiveTab(index) {
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach((btn, i) => {
                btn.classList.toggle('active', i === index);
            });
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach((content, i) => {
                content.classList.toggle('active', i === index);
            });
        }

        // Fetch and populate tickets
        async function fetchAndPopulateTickets() {
            try {
                // Try multiple possible keys for user ID
                let userID = localStorage.getItem('userId');
                
                if (!userID) {
                    // Try alternative keys
                    userID = localStorage.getItem('userID');
                }
                
                if (!userID) {
                    // Try to get from userData if it exists
                    const userData = localStorage.getItem('userData');
                    if (userData) {
                        try {
                            const user = JSON.parse(userData);
                            userID = user._id || user.id || user.userId;
                        } catch (e) {
                            console.warn('Failed to parse userData:', e);
                        }
                    }
                }
                
                if (!userID) {
                    document.getElementById('pending-tickets').innerHTML = '❌ No userId found in localStorage. Available keys: ' + Object.keys(localStorage).join(', ');
                    document.getElementById('completed-tickets').innerHTML = '❌ No userId found in localStorage. Available keys: ' + Object.keys(localStorage).join(', ');
                    return;
                }

                console.log('Fetching tickets for userId:', userID);
                
                const response = await fetch(`${API_BASE_URL}/tk/customer-service/${userID}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log('Tickets data received:', data);
                    
                    if (data.tickets && Array.isArray(data.tickets)) {
                        populateTicketList(data.tickets);
                    } else {
                        showNoTicketsMessage();
                    }
                } else {
                    document.getElementById('pending-tickets').innerHTML = `❌ Failed to fetch tickets: ${response.status}`;
                    document.getElementById('completed-tickets').innerHTML = `❌ Failed to fetch tickets: ${response.status}`;
                }
            } catch (error) {
                console.error('Error fetching tickets:', error);
                document.getElementById('pending-tickets').innerHTML = `❌ Error fetching tickets: ${error.message}`;
                document.getElementById('completed-tickets').innerHTML = `❌ Error fetching tickets: ${error.message}`;
            }
        }

        function populateTicketList(tickets) {
            console.log('Populating ticket list with', tickets.length, 'tickets');
            
            // Separate tickets by status
            const pendingTickets = tickets.filter(ticket => ticket.status !== 'resolved');
            const completedTickets = tickets.filter(ticket => ticket.status === 'resolved');
            
            console.log('Pending tickets:', pendingTickets.length);
            console.log('Completed tickets:', completedTickets.length);
            
            // Populate pending tickets
            const pendingContainer = document.getElementById('pending-tickets');
            if (pendingTickets.length > 0) {
                pendingContainer.innerHTML = '';
                pendingTickets.forEach(ticket => {
                    const ticketElement = createTicketElement(ticket, 'pending');
                    pendingContainer.appendChild(ticketElement);
                });
            } else {
                pendingContainer.innerHTML = '<p>No tickets yet...</p>';
            }
            
            // Populate completed tickets
            const completedContainer = document.getElementById('completed-tickets');
            if (completedTickets.length > 0) {
                completedContainer.innerHTML = '';
                completedTickets.forEach(ticket => {
                    const ticketElement = createTicketElement(ticket, 'completed');
                    completedContainer.appendChild(ticketElement);
                });
            } else {
                completedContainer.innerHTML = '<p>No tickets yet...</p>';
            }
            
            // Update tab button text
            updateTabButtonText(pendingTickets.length, completedTickets.length);
        }

        function createTicketElement(ticket, status) {
            const ticketElement = document.createElement('div');
            ticketElement.className = `ticket-item ${status === 'completed' ? 'opacity-75' : ''}`;
            ticketElement.setAttribute('data-ticket-id', ticket._id);
            
            // Get customer name from the first message (sender)
            const customerName = ticket.messages && ticket.messages.length > 0 
                ? ticket.messages[0].userName 
                : 'Unknown Customer';
            
            // Format date
            const ticketDate = new Date(ticket.createdAt);
            const formattedDate = ticketDate.toLocaleDateString();
            const formattedTime = ticketDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            // Get latest message preview
            const latestMessage = ticket.messages && ticket.messages.length > 0 
                ? ticket.messages[ticket.messages.length - 1].message 
                : 'No messages';
            
            ticketElement.innerHTML = `
                <div class="ticket-header">
                    <div class="ticket-number">#${ticket.ticketNumber}</div>
                    <span class="status-badge status-${status}">${status}</span>
                </div>
                <div class="ticket-info">
                    <div><strong>Customer:</strong> ${customerName}</div>
                    <div><strong>Category:</strong> ${ticket.category || 'No Category'}</div>
                    <div><strong>Created:</strong> ${formattedDate} at ${formattedTime}</div>
                    <div><strong>Latest Message:</strong> ${latestMessage.substring(0, 100)}${latestMessage.length > 100 ? '...' : ''}</div>
                </div>
            `;
            
            // Add click event to load ticket details
            ticketElement.addEventListener('click', () => {
                loadTicketDetails(ticket);
                // Update active state
                document.querySelectorAll('.ticket-item').forEach(item => {
                    item.classList.remove('ticket-active');
                });
                ticketElement.classList.add('ticket-active');
            });
            
            return ticketElement;
        }

        function loadTicketDetails(ticket) {
            console.log('Loading ticket details for:', ticket);
            
            const detailsDiv = document.getElementById('ticket-details');
            
            // Get customer name from the first message (sender)
            const customerName = ticket.messages && ticket.messages.length > 0 
                ? ticket.messages[0].userName 
                : 'Unknown Customer';
            
            // Format date
            const ticketDate = new Date(ticket.createdAt);
            const formattedDate = ticketDate.toLocaleDateString();
            const formattedTime = ticketDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            let messagesHTML = '';
            if (ticket.messages && ticket.messages.length > 0) {
                ticket.messages.forEach(message => {
                    const messageDate = new Date(message.dateTime);
                    const messageTime = messageDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    const isEmployee = message.userLevel === 'Employee';
                    
                    messagesHTML += `
                        <div class="message-${isEmployee ? 'csr' : 'guest'}">
                            <div class="message-bubble">
                                <div class="message-header">
                                    <strong>${message.userName}</strong> (${message.userLevel}) - ${messageTime}
                                </div>
                                <div class="message-content">${message.message}</div>
                            </div>
                        </div>
                    `;
                });
            }
            
            detailsDiv.innerHTML = `
                <div class="ticket-details-header">
                    <h3>Ticket #${ticket.ticketNumber}</h3>
                    <span class="status-badge status-${ticket.status === 'resolved' ? 'resolved' : 'pending'}">${ticket.status}</span>
                </div>
                <div class="ticket-details-info">
                    <p><strong>Customer:</strong> ${customerName}</p>
                    <p><strong>Category:</strong> ${ticket.category || 'No Category'}</p>
                    <p><strong>Created:</strong> ${formattedDate} at ${formattedTime}</p>
                    <p><strong>Messages:</strong> ${ticket.messages ? ticket.messages.length : 0}</p>
                </div>
                <div class="ticket-messages">
                    <h4>Message History:</h4>
                    ${messagesHTML || '<p>No messages found</p>'}
                </div>
            `;
        }

        function updateTabButtonText(pendingCount, completedCount) {
            const pendingTab = document.querySelector('.tab-btn:first-of-type');
            const completedTab = document.querySelector('.tab-btn:last-of-type');
            
            if (pendingTab) {
                pendingTab.textContent = `Pending (${pendingCount})`;
            }
            
            if (completedTab) {
                completedTab.textContent = `Completed (${completedCount})`;
            }
        }

        function showNoTicketsMessage() {
            document.getElementById('pending-tickets').innerHTML = '<p>No tickets yet...</p>';
            document.getElementById('completed-tickets').innerHTML = '<p>No tickets yet...</p>';
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded, checking localStorage and API...');
            checkLocalStorage();
            testAPI();
            
            // If userId exists, fetch tickets
            const userID = localStorage.getItem('userId');
            if (userID) {
                fetchAndPopulateTickets();
            }
        });
    </script>
</body>
</html>
