<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Test - Available & Booked Rentals</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-8">API Test - Available & Booked Rentals Fix</h1>
        
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-bold mb-4">Test Results</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div class="bg-blue-50 p-4 rounded-lg">
                    <h3 class="font-semibold text-blue-800">Available Rentals Today</h3>
                    <p class="text-2xl font-bold text-blue-600" id="availableRental">Loading...</p>
                    <p class="text-sm text-gray-600">API: /dashboard/admin/property/availableToday</p>
                </div>
                
                <div class="bg-green-50 p-4 rounded-lg">
                    <h3 class="font-semibold text-green-800">Booked Rentals Today</h3>
                    <p class="text-2xl font-bold text-green-600" id="bookedRoom">Loading...</p>
                    <p class="text-sm text-gray-600">API: /dashboard/admin/booking/todayCount</p>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h3 class="font-semibold text-gray-800">Total Employees</h3>
                    <p class="text-2xl font-bold text-gray-600" id="totalEmployee">Loading...</p>
                </div>
                
                <div class="bg-purple-50 p-4 rounded-lg">
                    <h3 class="font-semibold text-purple-800">Total Customers</h3>
                    <p class="text-2xl font-bold text-purple-600" id="totalCustomer">Loading...</p>
                </div>
                
                <div class="bg-orange-50 p-4 rounded-lg">
                    <h3 class="font-semibold text-orange-800">Total Properties</h3>
                    <p class="text-2xl font-bold text-orange-600" id="totalRoom">Loading...</p>
                </div>
            </div>
            
            <div class="flex gap-4 mb-6">
                <button onclick="testAPI()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                    Test API Endpoints
                </button>
                <button onclick="refreshData()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                    Refresh Data
                </button>
                <button onclick="showConsole()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
                    Show Console
                </button>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-bold mb-4">API Test Log</h2>
            <div id="logContainer" class="bg-gray-100 p-4 rounded font-mono text-sm h-64 overflow-y-auto">
                <p>Click "Test API Endpoints" to start testing...</p>
            </div>
        </div>
        
        <div class="mt-6 p-4 bg-blue-50 rounded-lg">
            <h3 class="font-bold text-lg mb-2">Fixes Applied:</h3>
            <ul class="list-disc list-inside space-y-1 text-sm">
                <li><strong>Fixed API Endpoints:</strong> Updated incorrect paths to use /dashboard/admin/ prefix</li>
                <li><strong>Fixed Data Parsing:</strong> Updated to use correct property names from API responses</li>
                <li><strong>availableToday:</strong> Now uses 'availableRoomCount' instead of 'count'</li>
                <li><strong>todayBookings:</strong> Now uses 'activeBookingsToday' instead of 'count'</li>
                <li><strong>Better Error Handling:</strong> Added detailed logging for debugging</li>
                <li><strong>Progress Bars:</strong> Updated to use correct data properties</li>
            </ul>
        </div>
    </div>

    <script>
        const API_BASE = 'https://betcha-api.onrender.com';
        
        const DASHBOARD_ENDPOINTS = {
            employeeCount: `${API_BASE}/dashboard/admin/employee/activeCount`,
            guestCount: `${API_BASE}/dashboard/admin/guest/activeCount`,
            propertyCount: `${API_BASE}/dashboard/admin/property/activeCount`,
            todayBookingCount: `${API_BASE}/dashboard/admin/booking/todayCount`,
            availableToday: `${API_BASE}/dashboard/admin/property/availableToday`,
            activeBookingCount: `${API_BASE}/dashboard/admin/booking/activeCount`
        };
        
        function log(message) {
            const logContainer = document.getElementById('logContainer');
            const time = new Date().toLocaleTimeString();
            logContainer.innerHTML += `<p>[${time}] ${message}</p>`;
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        async function testAPI() {
            const logContainer = document.getElementById('logContainer');
            logContainer.innerHTML = '<p>Starting API tests...</p>';
            
            log('=== Testing API Endpoints ===');
            
            try {
                // Test Available Today
                log(`Testing: ${DASHBOARD_ENDPOINTS.availableToday}`);
                const availableResponse = await fetch(DASHBOARD_ENDPOINTS.availableToday);
                log(`Available Today Status: ${availableResponse.status}`);
                if (availableResponse.ok) {
                    const availableData = await availableResponse.json();
                    log(`Available Today Data: ${JSON.stringify(availableData)}`);
                    log(`Available Count: ${availableData.availableRoomCount}`);
                }
                
                // Test Today Bookings
                log(`Testing: ${DASHBOARD_ENDPOINTS.todayBookingCount}`);
                const bookingsResponse = await fetch(DASHBOARD_ENDPOINTS.todayBookingCount);
                log(`Today Bookings Status: ${bookingsResponse.status}`);
                if (bookingsResponse.ok) {
                    const bookingsData = await bookingsResponse.json();
                    log(`Today Bookings Data: ${JSON.stringify(bookingsData)}`);
                    log(`Bookings Count: ${bookingsData.activeBookingsToday}`);
                }
                
                // Test Active Bookings
                log(`Testing: ${DASHBOARD_ENDPOINTS.activeBookingCount}`);
                const activeResponse = await fetch(DASHBOARD_ENDPOINTS.activeBookingCount);
                log(`Active Bookings Status: ${activeResponse.status}`);
                if (activeResponse.ok) {
                    const activeData = await activeResponse.json();
                    log(`Active Bookings Data: ${JSON.stringify(activeData)}`);
                }
                
                log('=== API Test Complete ===');
                
            } catch (error) {
                log(`ERROR: ${error.message}`);
            }
        }
        
        async function refreshData() {
            log('Refreshing dashboard data...');
            
            try {
                const [
                    employeeResponse,
                    guestResponse,
                    propertyResponse,
                    todayBookingResponse,
                    availableTodayResponse,
                    activeBookingResponse
                ] = await Promise.all([
                    fetch(DASHBOARD_ENDPOINTS.employeeCount),
                    fetch(DASHBOARD_ENDPOINTS.guestCount),
                    fetch(DASHBOARD_ENDPOINTS.propertyCount),
                    fetch(DASHBOARD_ENDPOINTS.todayBookingCount),
                    fetch(DASHBOARD_ENDPOINTS.availableToday),
                    fetch(DASHBOARD_ENDPOINTS.activeBookingCount)
                ]);
                
                log(`Response statuses: Employee(${employeeResponse.status}), Guest(${guestResponse.status}), Property(${propertyResponse.status}), TodayBooking(${todayBookingResponse.status}), Available(${availableTodayResponse.status}), Active(${activeBookingResponse.status})`);
                
                const countsData = {
                    employees: employeeResponse.ok ? await employeeResponse.json() : { count: 0 },
                    guests: guestResponse.ok ? await guestResponse.json() : { count: 0 },
                    properties: propertyResponse.ok ? await propertyResponse.json() : { count: 0 },
                    todayBookings: todayBookingResponse.ok ? await todayBookingResponse.json() : { activeBookingsToday: 0 },
                    availableToday: availableTodayResponse.ok ? await availableTodayResponse.json() : { availableRoomCount: 0 },
                    activeBookings: activeBookingResponse.ok ? await activeBookingResponse.json() : { count: 0 }
                };
                
                log(`Parsed data: ${JSON.stringify(countsData)}`);
                
                // Update UI
                document.getElementById('availableRental').textContent = countsData.availableToday.availableRoomCount || 0;
                document.getElementById('bookedRoom').textContent = countsData.todayBookings.activeBookingsToday || 0;
                document.getElementById('totalEmployee').textContent = countsData.employees.count || 0;
                document.getElementById('totalCustomer').textContent = countsData.guests.count || 0;
                document.getElementById('totalRoom').textContent = countsData.properties.count || 0;
                
                log('Data updated successfully!');
                
            } catch (error) {
                log(`ERROR refreshing data: ${error.message}`);
            }
        }
        
        function showConsole() {
            alert('Check the browser console (F12) for detailed logs');
        }
        
        // Load data on page load
        document.addEventListener('DOMContentLoaded', function() {
            refreshData();
        });
    </script>
</body>
</html>
