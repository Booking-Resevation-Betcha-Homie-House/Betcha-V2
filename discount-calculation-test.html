<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/src/index.css">
    <title>Discount Calculation Test</title>
</head>
<body class="bg-background p-10">
    <div class="max-w-lg mx-auto bg-white p-8 rounded-3xl shadow-sm border border-neutral-300">
        <h1 class="text-2xl font-bold mb-6">Discount Calculation Test</h1>
        
        <div class="mb-6">
            <h2 class="text-lg font-semibold mb-4">Your Booking Data:</h2>
            <pre id="bookingData" class="bg-gray-100 p-4 rounded text-sm overflow-auto"></pre>
        </div>
        
        <div class="mb-6">
            <h2 class="text-lg font-semibold mb-4">Calculation Results:</h2>
            <div id="results" class="bg-blue-50 p-4 rounded">
                <p><strong>Discount Field:</strong> <span id="discountField">-</span></p>
                <p><strong>Total Fee:</strong> â‚±<span id="totalFee">-</span></p>
                <p><strong>Calculated Discount %:</strong> <span id="calculatedPercentage">-</span>%</p>
                <p><strong>Calculated Discount Amount:</strong> â‚±<span id="calculatedAmount">-</span></p>
            </div>
        </div>
        
        <!-- Discount Section (copied from confirm-payment.html) -->
        <div id="discountSection" class="flex justify-between items-center mb-2 p-4 bg-green-50 rounded" style="display: flex;">
            <p class="text-green-600 font-bold font-manrope">Discount (<span id="discountPercentage">0%</span>)</p>
            <p class="text-green-600 font-inter">-â‚± <span id="discount">0</span></p>
        </div>
        
        <button id="testButton" class="bg-blue-500 text-white px-4 py-2 rounded w-full">Test Calculation</button>
    </div>

    <script>
        // Your exact booking data
        const booking = {
            "reservation": {
                "modeOfPayment": "Pending",
                "paymentNo": "Pending",
                "status": "Pending",
                "numberBankEwallets": "N/A"
            },
            "package": {
                "modeOfPayment": "Pending",
                "paymentNo": "Pending",
                "status": "Pending",
                "numberBankEwallets": "N/A"
            },
            "_id": "68ad7fc7a28cc32a6dd2ea71",
            "transNo": "000000056",
            "propertyName": "Demo Resort 1",
            "propertyId": "685ec7548e71fd2d8829f03d",
            "guestId": "68ac05abddaaa566123b0cf1",
            "guestName": "null null",
            "status": "Pending Payment",
            "paymentCategory": "",
            "reservationFee": 500,
            "packageFee": 10000,
            "discount": 5,
            "additionalPaxPrice": 200,
            "additionalPax": 1,
            "datesOfBooking": [
                "2025-09-02T00:00:00.000Z",
                "2025-09-03T00:00:00.000Z",
                "2025-09-04T00:00:00.000Z"
            ],
            "totalFee": 29200,
            "numOfDays": 3,
            "checkIn": "2025-09-02T00:00:00.000Z",
            "checkOut": "2025-09-04T00:00:00.000Z",
            "timeIn": "1:00 PM",
            "timeOut": "11:00 AM",
            "rating": 0,
            "createdAt": "2025-08-26T09:35:03.444Z",
            "updatedAt": "2025-08-26T09:35:03.444Z",
            "__v": 0
        };

        // Copy the functions from confirm-payment-functions.js
        function calculateDiscountPercentage(booking) {
            try {
                const discount = booking.discount || 0;
                const totalFee = booking.totalFee || 0;
                
                if (discount === 0 || totalFee === 0) {
                    return 0;
                }
                
                // Check if discount is already a percentage (typically less than 100)
                // or if it's an absolute amount (typically larger than 100)
                if (discount <= 100) {
                    // Discount is likely already a percentage
                    console.log('Discount appears to be a percentage:', discount);
                    return discount;
                } else {
                    // Discount is an absolute amount, calculate percentage
                    console.log('Discount appears to be an absolute amount:', discount);
                    
                    // Calculate the original total before discount
                    const originalTotal = totalFee + discount;
                    
                    // Calculate percentage: (discount / originalTotal) * 100
                    const percentage = (discount / originalTotal) * 100;
                    
                    // Round to 1 decimal place
                    const roundedPercentage = Math.round(percentage * 10) / 10;
                    
                    console.log('Discount percentage calculation (absolute):', {
                        discount,
                        totalFee,
                        originalTotal,
                        percentage,
                        roundedPercentage
                    });
                    
                    return roundedPercentage;
                }
            } catch (error) {
                console.error('Error calculating discount percentage:', error);
                return 0;
            }
        }

        function calculateDiscountAmount(booking) {
            try {
                const discount = booking.discount || 0;
                const totalFee = booking.totalFee || 0;
                
                if (discount === 0 || totalFee === 0) {
                    return 0;
                }
                
                // Check if discount is already a percentage or absolute amount
                if (discount <= 100) {
                    // Discount is a percentage, calculate the amount
                    // We need to calculate based on the original total before discount
                    // If totalFee is after discount: originalTotal = totalFee / (1 - discount/100)
                    // But it's safer to calculate: discountAmount = totalFee * (discount / (100 - discount))
                    const discountAmount = totalFee * (discount / (100 - discount));
                    
                    console.log('Discount amount calculation (from percentage):', {
                        discountPercentage: discount,
                        totalFee,
                        calculatedDiscountAmount: discountAmount
                    });
                    
                    return Math.round(discountAmount);
                } else {
                    // Discount is already an absolute amount
                    console.log('Discount is already an absolute amount:', discount);
                    return discount;
                }
            } catch (error) {
                console.error('Error calculating discount amount:', error);
                return 0;
            }
        }

        function runTest() {
            console.log('ðŸ§ª Testing with your booking data:', booking);
            
            const discountPercentage = calculateDiscountPercentage(booking);
            const discountAmount = calculateDiscountAmount(booking);
            
            // Display booking data
            document.getElementById('bookingData').textContent = JSON.stringify({
                discount: booking.discount,
                totalFee: booking.totalFee,
                reservationFee: booking.reservationFee,
                packageFee: booking.packageFee
            }, null, 2);
            
            // Display results
            document.getElementById('discountField').textContent = booking.discount;
            document.getElementById('totalFee').textContent = booking.totalFee.toLocaleString();
            document.getElementById('calculatedPercentage').textContent = discountPercentage;
            document.getElementById('calculatedAmount').textContent = discountAmount.toLocaleString();
            
            // Update discount section
            document.getElementById('discountPercentage').textContent = discountPercentage + '%';
            document.getElementById('discount').textContent = discountAmount.toLocaleString();
            
            console.log('âœ… Test Results:', {
                originalDiscount: booking.discount,
                discountPercentage,
                discountAmount,
                totalFee: booking.totalFee
            });
        }

        // Run test on button click
        document.getElementById('testButton').addEventListener('click', runTest);
        
        // Run test immediately
        runTest();
    </script>
</body>
</html>
